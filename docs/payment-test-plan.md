# 支付宝支付功能测试计划

## 测试目标

验证支付宝沙箱支付功能是否正常工作，特别是确保订单状态能从"待支付"(1)正确更新为"已支付"(2)。

## 测试环境准备

1. 确保应用配置了正确的支付宝沙箱参数，尤其是：
   - 应用ID (appId)
   - 应用私钥 (appPrivateKey)
   - 支付宝公钥 (alipayPublicKey)
   - 异步通知地址 (notifyUrl)：应确保为可外部访问的URL
   - 同步跳转地址 (returnUrl)

2. 如果在本地开发环境测试，请使用内网穿透工具（如ngrok、frp）将本地服务器暴露到公网，使支付宝可以访问异步通知地址。

## 测试流程

### 1. 基础功能测试

- **创建订单**：创建一个新预约订单，确认订单初始状态为"待支付"(1)
- **状态查询**：使用订单号查询订单状态，确认为"待支付"

### 2. 支付宝支付测试

- **发起支付**：在订单详情页点击"立即支付"按钮
- **支付宝页面**：确认能够正确跳转到支付宝沙箱支付页面
- **完成支付**：在支付宝沙箱环境中完成支付
- **支付结果**：观察支付完成后是否正确返回到应用的支付成功页面
- **状态查询**：查询订单状态，确认是否更新为"已支付"(2)

### 3. 异步通知测试

如果支付成功但订单状态未更新，请手动测试异步通知处理：

- **查看日志**：检查服务器日志是否有接收到支付宝异步通知的记录
- **模拟回调**：使用"支付回调测试工具"页面，输入订单号并点击"模拟支付回调"按钮
- **状态查询**：检查订单状态是否已更新为"已支付"(2)

### 4. 手动更新测试

如果自动更新仍有问题，测试手动更新功能：

- **直接更新**：在"支付回调测试工具"页面，输入订单号并点击"直接更新状态"按钮
- **状态查询**：确认订单状态是否已更新为"已支付"(2)

- **直接SQL更新**：如果上述方法仍不生效，点击"直接SQL更新状态"按钮
- **状态查询**：确认订单状态是否已更新为"已支付"(2)

## 常见问题处理

1. **支付宝回调问题**：
   - 确认`application.yml`中的`notifyUrl`指向可外部访问的地址
   - 检查服务器防火墙是否阻止了外部请求
   - 确认网络穿透工具工作正常

2. **状态更新问题**：
   - 观察服务器日志中的错误信息
   - 检查数据库事务是否正常提交
   - 使用"直接SQL更新状态"按钮绕过事务机制

3. **数据库锁定问题**：
   - 检查数据库连接数是否足够
   - 确认没有长时间运行的事务占用资源
   - 调整数据库的事务隔离级别

## 测试期望结果

1. 用户完成支付后，订单状态应自动更新为"已支付"(2)
2. 如自动更新失败，手动触发更新应能成功将状态更新为"已支付"(2)
3. 系统应记录详细日志，方便排查问题

## 后续优化建议

1. 实现支付状态定时查询机制，定期检查未支付订单的实际支付状态
2. 优化事务管理，避免因事务问题导致状态更新失败
3. 改进错误处理和重试机制，提高系统稳定性 